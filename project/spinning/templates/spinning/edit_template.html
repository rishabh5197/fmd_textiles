{% extends "base.html" %}

{% block head %}
  {{ super() }}
{% endblock %}

{% block content %}
<div class="wrap">
  <div class="card">
    <h2>Going to Edit :- {{ entry_number }} — {{ entry_fabric }} — {{ number_of_bales }} bales</h2>
    <div class="sub">“Recycled” default is <strong>OFF</strong>. Toggle ON to set “yes”.</div>

    <form id="editForm" action="{{ url_for('spinning.edit_entry', entry_id=entry_number) }}" method="POST">
      <!-- Header fields -->
      <div class="grid-2">
        <div class="row">
          <label class="field">Country of origin</label>
          <input type="text" name="country_of_origin" value="{{ country_of_origin }}">
        </div>
        <div class="row">
          <label class="field">Name of cotton</label>
          <input type="text" name="entry_fabric" value="{{ entry_fabric }}">
        </div>
        <div class="row">
          <label class="field">Invoice number</label>
          <input type="text" name="invoice_number" value="{{ invoice_number }}">
        </div>
        <div class="row">
          <label class="field">Party</label>
          <input type="text" name="party" value="{{ party }}">
        </div>
        <div class="row">
          <label class="field">Date of arrival</label>
          <input type="text" name="date_of_arrival" value="{{ date_of_arrival }}">
        </div>
        <div class="row">
          <label class="field">Nt. Weight</label>
          <input type="text" name="nt_weight" value="{{ nt_weight }}">
        </div>
        <div class="row">
          <label class="field">BCI (better cotton index)</label>
          <input type="text" name="bci" value="{{ bci }}">
        </div>
      </div>

      <!-- Bale rows as 2-column grid -->
      <div class="bales">
        <div class="bhead"><div>#</div><div>Variant</div><div>Recycled</div></div>

        {% for i in range(1, number_of_bales + 1) %}
          {% set v = (variants[i-1] if variants and variants|length >= i else "") %}
          {% set rlist = recycled if recycled is defined else None %}
          {% set r = (rlist[i-1] if rlist and rlist|length >= i else "no") %}
          <div class="brow">
            <div class="bidx">{{ i }}</div>

            <div>
              <input
                type="text"
                id="variant{{ i }}"
                name="variant{{ i }}"
                placeholder="{{ entry_fabric }} - {{ i }}"
                value="{{ v }}"
              >
            </div>

            <!-- Power Switch Toggle -->
            <label class="toggle" aria-label="Recycled for bale {{ i }}">
              <input
                type="checkbox"
                id="chk{{ i }}"
                {% if r|lower == 'yes' %}checked{% endif %}
                role="switch"
                aria-checked="{{ 'true' if r|lower == 'yes' else 'false' }}"
              >
              <span class="slider"></span>
            </label>
            <input type="hidden" name="recycled{{ i }}" id="recycled{{ i }}" value="{{ 'yes' if r|lower == 'yes' else 'no' }}">
          </div>
        {% endfor %}
      </div>

      <div class="actions">
        <button type="reset" class="btn ghost">Reset</button>
        <button type="submit" class="btn primary">Save</button>
      </div>
    </form>
  </div>
</div>

<!-- Sync JS -->
<script>
(function(){
  function sync(chk){
    const idx = chk.id.replace('chk','');
    const hid = document.getElementById('recycled'+idx);
    if (hid){
      hid.value = chk.checked ? 'yes' : 'no';
      chk.setAttribute('aria-checked', chk.checked ? 'true' : 'false');
    }
  }
  const checks = document.querySelectorAll('input[type="checkbox"][id^="chk"]');
  checks.forEach(chk=>{
    sync(chk);
    chk.addEventListener('change', ()=>sync(chk));
  });
  const form = document.getElementById('editForm');
  if (form){
    form.addEventListener('reset', ()=>{
      setTimeout(()=>{ checks.forEach(chk=>sync(chk)); },0);
    });
  }
})();
</script>
{% endblock %}
